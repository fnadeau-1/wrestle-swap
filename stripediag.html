<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stripe Diagnostic Tool</title>
    <style>
        body {
            font-family: monospace;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #1e1e1e;
            color: #00ff00;
        }
        h1 { color: #00ff00; }
        .test-section {
            background: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #00ff00;
        }
        .success { color: #00ff00; }
        .error { color: #ff0000; }
        .warning { color: #ffaa00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
        }
        button:hover {
            background: #00cc00;
        }
        pre {
            background: #000;
            padding: 15px;
            overflow-x: auto;
            border: 1px solid #00ff00;
        }
        input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: #000;
            border: 1px solid #00ff00;
            color: #00ff00;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîç Stripe Payment Diagnostic Tool</h1>
    <p>This tool helps diagnose Stripe payment issues</p>

    <!-- Test 1: Check API Endpoint -->
    <div class="test-section">
        <h2>Test 1: Backend Connection</h2>
        <p>Testing connection to your payment backend...</p>
        <button onclick="testBackend()">Test Backend</button>
        <div id="backend-result"></div>
    </div>

    <!-- Test 2: Create Payment Intent -->
    <div class="test-section">
        <h2>Test 2: Create Payment Intent</h2>
        <p>Attempt to create a new payment intent...</p>
        <label>Amount (in cents): <input type="number" id="test-amount" value="5399"></label>
        <button onclick="testCreatePayment()">Create Payment Intent</button>
        <div id="payment-result"></div>
    </div>

    <!-- Test 3: Check Stripe Keys -->
    <div class="test-section">
        <h2>Test 3: Stripe Keys Check</h2>
        <p>Verify your Stripe publishable key...</p>
        <label>Your Publishable Key: 
            <input type="text" id="pub-key" value="pk_test_51SVkt7GuAs8IZaZv5J9AezLqjENqgpK1MWVMze9O7fUY5h8ZUAmvC2uHavTLzKloXToKxvFDtGeJ9jE3umH9Uvxp00168b1lMz">
        </label>
        <button onclick="checkKeys()">Check Keys</button>
        <div id="keys-result"></div>
    </div>

    <!-- Test 4: Payment Intent Lookup -->
    <div class="test-section">
        <h2>Test 4: Look Up Payment Intent</h2>
        <p>Try to retrieve an existing payment intent...</p>
        <label>Payment Intent ID: 
            <input type="text" id="pi-id" placeholder="pi_3Sf73cGjf88NEQS11XtTloJY">
        </label>
        <button onclick="lookupPaymentIntent()">Look Up</button>
        <div id="lookup-result"></div>
    </div>

    <!-- Logs -->
    <div class="test-section">
        <h2>Console Logs</h2>
        <pre id="logs"></pre>
    </div>

    <script>
        const log = (message, type = 'info') => {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#ff0000' : type === 'success' ? '#00ff00' : '#ffaa00';
            logs.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            console.log(message);
        };

        // Test 1: Backend Connection
        async function testBackend() {
            const result = document.getElementById('backend-result');
            result.innerHTML = '<p class="warning">Testing...</p>';
            log('Testing backend connection...');

            try {
                const response = await fetch('https://createpaymentintent-kebvkf67ma-uc.a.run.app', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: 100,
                        currency: 'usd'
                    })
                });

                log(`Backend response status: ${response.status}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                
                if (response.ok && data.clientSecret) {
                    result.innerHTML = `
                        <p class="success">‚úì Backend is working!</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Backend test PASSED', 'success');
                } else {
                    result.innerHTML = `
                        <p class="error">‚úó Backend returned unexpected response</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Backend test FAILED: Unexpected response', 'error');
                }
            } catch (error) {
                result.innerHTML = `
                    <p class="error">‚úó Backend connection failed</p>
                    <pre>${error.message}</pre>
                `;
                log(`Backend test FAILED: ${error.message}`, 'error');
            }
        }

        // Test 2: Create Payment Intent
        async function testCreatePayment() {
            const result = document.getElementById('payment-result');
            const amount = document.getElementById('test-amount').value;
            result.innerHTML = '<p class="warning">Creating payment intent...</p>';
            log(`Creating payment intent for ${amount} cents...`);

            try {
                const response = await fetch('https://createpaymentintent-kebvkf67ma-uc.a.run.app', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseInt(amount),
                        currency: 'usd'
                    })
                });

                const data = await response.json();
                log(`Payment intent response: ${JSON.stringify(data)}`, response.ok ? 'success' : 'error');

                if (data.clientSecret) {
                    // Extract payment intent ID from client secret
                    const piId = data.clientSecret.split('_secret_')[0];
                    
                    result.innerHTML = `
                        <p class="success">‚úì Payment Intent Created!</p>
                        <pre>Payment Intent ID: ${piId}
Client Secret: ${data.clientSecret.substring(0, 30)}...

Full Response:
${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Payment intent created successfully', 'success');
                    
                    // Auto-fill the lookup field
                    document.getElementById('pi-id').value = piId;
                } else {
                    result.innerHTML = `
                        <p class="error">‚úó Failed to create payment intent</p>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    `;
                    log('Failed to create payment intent', 'error');
                }
            } catch (error) {
                result.innerHTML = `
                    <p class="error">‚úó Error: ${error.message}</p>
                `;
                log(`Error creating payment intent: ${error.message}`, 'error');
            }
        }

        // Test 3: Check Keys
        function checkKeys() {
            const result = document.getElementById('keys-result');
            const pubKey = document.getElementById('pub-key').value;
            
            log('Checking Stripe keys...');

            let issues = [];
            let warnings = [];

            // Check if test or live key
            if (pubKey.startsWith('pk_test_')) {
                warnings.push('Using TEST mode key (this is fine for testing)');
                log('TEST mode detected', 'warning');
            } else if (pubKey.startsWith('pk_live_')) {
                warnings.push('Using LIVE mode key - make sure backend is also in live mode!');
                log('LIVE mode detected', 'warning');
            } else {
                issues.push('Invalid key format - should start with pk_test_ or pk_live_');
                log('Invalid key format', 'error');
            }

            // Check key length
            if (pubKey.length < 50) {
                issues.push('Key seems too short - may be incomplete');
                log('Key length issue', 'error');
            }

            let html = '';
            if (issues.length > 0) {
                html += '<div class="error"><h3>Issues:</h3><ul>';
                issues.forEach(issue => html += `<li>${issue}</li>`);
                html += '</ul></div>';
            }
            if (warnings.length > 0) {
                html += '<div class="warning"><h3>Warnings:</h3><ul>';
                warnings.forEach(warning => html += `<li>${warning}</li>`);
                html += '</ul></div>';
            }
            if (issues.length === 0) {
                html += '<p class="success">‚úì Publishable key format looks good!</p>';
                log('Key check PASSED', 'success');
            }

            result.innerHTML = html;
        }

        // Test 4: Payment Intent Lookup
        async function lookupPaymentIntent() {
            const result = document.getElementById('lookup-result');
            const piId = document.getElementById('pi-id').value;
            
            result.innerHTML = '<p class="warning">Looking up payment intent...</p>';
            log(`Looking up payment intent: ${piId}`);

            if (!piId) {
                result.innerHTML = '<p class="error">Please enter a Payment Intent ID</p>';
                return;
            }

            result.innerHTML = `
                <p class="warning">‚ö†Ô∏è Cannot lookup from frontend</p>
                <p>Payment Intent lookup requires your SECRET key, which should never be exposed in frontend code.</p>
                <p>To check this payment intent:</p>
                <ol>
                    <li>Go to <a href="https://dashboard.stripe.com/test/payments" target="_blank" style="color: #00ff00;">Stripe Dashboard ‚Üí Payments</a></li>
                    <li>Search for: <code>${piId}</code></li>
                    <li>Check if it exists and which mode (test/live) it's in</li>
                </ol>
                <h4>Common Issues:</h4>
                <ul>
                    <li><strong>Not found:</strong> Payment Intent was created in LIVE mode, but you're checking TEST mode (or vice versa)</li>
                    <li><strong>Wrong account:</strong> Payment Intent was created with a different Stripe account</li>
                    <li><strong>Expired:</strong> Payment Intent is too old (they expire after 24 hours)</li>
                </ul>
            `;
            log('Payment Intent lookup requires backend access', 'warning');
        }

        // Auto-run basic tests on load
        window.addEventListener('load', () => {
            log('Diagnostic tool loaded', 'success');
            log('Ready to test Stripe integration');
            checkKeys();
        });
    </script>
</body>
</html>