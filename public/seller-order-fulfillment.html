<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Fulfillment - Seller | Wrestle Swap</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/layout.css">
    <style>
        /* Page-specific styles for seller-order-fulfillment.html */
        .seller-badge {
            background: #28a745;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        .container {
            max-width: 1000px;
            margin: 40px auto;
            padding: 0 20px;
        }

        .fulfillment-card {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-section {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 30px;
            border-bottom: 2px solid #e5e5e5;
        }

        .header-icon {
            font-size: 64px;
            margin-bottom: 15px;
        }

        .header-title {
            font-size: 28px;
            color: #333;
            margin-bottom: 10px;
        }

        .header-subtitle {
            font-size: 16px;
            color: #707070;
        }

        .section-title {
            font-size: 20px;
            color: #333;
            margin: 30px 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #e5e5e5;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }

        .alert-box.success {
            background: #d4edda;
            border-left-color: #28a745;
        }

        .alert-box.info {
            background: #d1ecf1;
            border-left-color: #17a2b8;
        }

        .shoes-warning {
            background: linear-gradient(135deg, #ff4444, #cc0000);
            color: white;
            padding: 25px 30px;
            margin: 25px 0;
            border-radius: 12px;
            border: 4px solid #990000;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
        }

        .shoes-warning-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .shoes-warning-text {
            font-size: 18px;
            line-height: 1.6;
            font-weight: 500;
        }

        .shoes-warning-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .alert-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .alert-text {
            font-size: 14px;
            line-height: 1.6;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .info-box {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #707070;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            word-break: break-word;
        }

        .order-item {
            display: flex;
            gap: 20px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #e5e5e5;
        }

        .item-image {
            width: 120px;
            height: 120px;
            background: #e0e0e0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin-bottom: 8px;
        }

        .item-condition {
            font-size: 14px;
            color: #707070;
            margin-bottom: 8px;
        }

        .item-price {
            font-size: 24px;
            font-weight: bold;
            color: #28a745;
        }

        .shipping-address {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px solid #2196f3;
        }

        .address-title {
            font-weight: bold;
            color: #1976d2;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .address-line {
            font-size: 15px;
            color: #333;
            line-height: 1.8;
        }

        .label-section {
            background: #d4edda;
            padding: 25px;
            border-radius: 8px;
            margin: 20px 0;
            border: 3px solid #28a745;
        }

        .label-title {
            font-size: 20px;
            font-weight: bold;
            color: #155724;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .label-info {
            background: white;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .tracking-display {
            font-size: 18px;
            font-family: monospace;
            color: #333;
            background: white;
            padding: 12px;
            border-radius: 4px;
            margin: 10px 0;
            border: 2px dashed #28a745;
        }

        .btn {
            display: inline-block;
            padding: 14px 28px;
            text-align: center;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            font-size: 16px;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
        }

        .btn-primary {
            background: #28a745;
            color: white;
        }

        .btn-primary:hover {
            background: #218838;
        }

        .btn-secondary {
            background: #3665f3;
            color: white;
        }

        .btn-secondary:hover {
            background: #2348c5;
        }

        .btn-outline {
            background: white;
            color: #333;
            border: 2px solid #e5e5e5;
        }

        .btn-outline:hover {
            background: #f9f9f9;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .checklist {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .checklist-item {
            padding: 12px 0;
            border-bottom: 1px solid #e5e5e5;
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checklist-item:last-child {
            border-bottom: none;
        }

        .checklist-icon {
            font-size: 20px;
        }

        .package-info {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .package-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
        }

        @media print {
            .no-print {
                display: none !important;
            }
            
            body {
                background: white;
            }

            .fulfillment-card {
                box-shadow: none;
                padding: 20px;
            }
        }

        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            }

            .order-item {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }

            .fulfillment-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="top-bar no-print">
        <div class="header-content">
            <a href="index.html" class="logo">Wrestle Swap</a>
            <div class="seller-badge">SELLER PORTAL</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="fulfillment-card">
            <div class="header-section">
                <div class="header-icon">üì¶</div>
                <h1 class="header-title">New Order to Fulfill</h1>
                <p class="header-subtitle">Please prepare this item for shipping</p>
            </div>

            <!-- Important Alert -->
            <div class="alert-box success">
                <div class="alert-title">‚úÖ Payment Received</div>
                <div class="alert-text">
                    The buyer's payment has been processed successfully. Please ship this item within 2 business days.
                </div>
            </div>

            <!-- Wrestling Shoes Warning -->
            <div class="shoes-warning">
                <div class="shoes-warning-icon">üëü‚ö†Ô∏è</div>
                <div class="shoes-warning-title">üö® Wrestling Shoes Alert üö®</div>
                <div class="shoes-warning-text">
                    If this order contains <strong>WRESTLING SHOES</strong>, do <strong>NOT</strong> ship them in the original shoe box!<br><br>
                    The shipping label was created based on specific package dimensions. Shipping in the original shoe box will result in <strong>incorrect packaging</strong> and item <strong>will not</strong> be able to be delivered properly.<br><br>
                    <strong>Remove shoes from the original box and use appropriate packaging that matches the label dimensions.</strong>
                </div>
            </div>

            <!-- Order Information -->
            <h2 class="section-title">üìã Order Information</h2>
            <div class="info-grid">
                <div class="info-box">
                    <div class="info-label">Order ID</div>
                    <div class="info-value" id="order-id">Loading...</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Order Date</div>
                    <div class="info-value" id="order-date">Loading...</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Shipping Service</div>
                    <div class="info-value" id="shipping-service">Loading...</div>
                </div>
                <div class="info-box">
                    <div class="info-label">Tracking Number</div>
                    <div class="info-value" id="tracking-number-display">Loading...</div>
                </div>
            </div>

            <!-- Item Details -->
            <h2 class="section-title">üõçÔ∏è Item to Ship</h2>
            <div id="order-items">
                <!-- Items will be loaded here -->
            </div>

            <!-- Shipping Label Section -->
            <div id="label-section">
                <h2 class="section-title">üìÑ Shipping Label</h2>
                <div class="label-section">
                    <div class="label-title">
                        <span>üè∑Ô∏è</span>
                        Your Shipping Label is Ready
                    </div>
                    <div class="label-info">
                        <p style="margin-bottom: 10px;"><strong>Tracking Number:</strong></p>
                        <div class="tracking-display" id="tracking-number">Loading...</div>
                    </div>
                    <div class="button-group">
                        <a href="#" id="download-label-btn" class="btn btn-primary" target="_blank">
                            üì• Download Shipping Label (PDF)
                        </a>
                        <a href="#" id="track-shipment-btn" class="btn btn-secondary" target="_blank">
                            üîç Track Shipment
                        </a>
                    </div>
                </div>
            </div>

            <!-- Shipping Address -->
            <h2 class="section-title">üìç Ship To Address</h2>
            <div class="shipping-address" id="shipping-address">
                <div class="address-title">Buyer's Shipping Address:</div>
                <div class="address-line">Loading address...</div>
            </div>

            <!-- Package Information -->
            <h2 class="section-title">üì¶ Package Details</h2>
            <div class="package-info">
                <div class="package-row">
                    <span>Package Size:</span>
                    <span>10" x 8" x 4"</span>
                </div>
                <div class="package-row">
                    <span>Weight:</span>
                    <span>2 lbs</span>
                </div>
            </div>

            <!-- Shipping Instructions -->
            <h2 class="section-title">üìù Shipping Instructions</h2>
            <div class="alert-box info">
                <div class="alert-title">How to Ship This Order:</div>
                <div class="checklist">
                    <div class="checklist-item">
                        <span class="checklist-icon">1Ô∏è‚É£</span>
                        <span><strong>Print the shipping label</strong> - Click the "Download Shipping Label" button above</span>
                    </div>
                    <div class="checklist-item">
                        <span class="checklist-icon">2Ô∏è‚É£</span>
                        <span><strong>Pack the item securely</strong> - Use appropriate packaging materials to protect the item</span>
                    </div>
                    <div class="checklist-item">
                        <span class="checklist-icon">3Ô∏è‚É£</span>
                        <span><strong>Attach the label</strong> - Securely tape the printed label to the outside of the package</span>
                    </div>
                    <div class="checklist-item">
                        <span class="checklist-icon">4Ô∏è‚É£</span>
                        <span><strong>Drop off the package</strong> - Take it to the carrier location (USPS, UPS, etc.) or schedule a pickup</span>
                    </div>
                    <div class="checklist-item">
                        <span class="checklist-icon">5Ô∏è‚É£</span>
                        <span><strong>Done!</strong> - The buyer will receive automatic tracking updates</span>
                    </div>
                </div>
            </div>

            <!-- Important Notes -->
            <div class="alert-box">
                <div class="alert-title">‚ö†Ô∏è Important Notes:</div>
                <div class="alert-text">
                    <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                        <li>Ship within <strong>2 business days</strong> to maintain good seller ratings</li>
                        <li>The shipping cost has already been paid - you don't need to pay anything</li>
                        <li>Do NOT write on or damage the shipping label</li>
                        <li>Keep a copy of this page for your records</li>
                        <li>The tracking number is automatically shared with the buyer</li>
                    </ul>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-group no-print">
                <button onclick="window.print()" class="btn btn-outline">
                    üñ®Ô∏è Print This Page
                </button>
                <a href="index.html" class="btn btn-outline">
                    ‚Üê Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBrNzOA__bI6zA2PvTFTujmFiBLsCe1iBk",
            authDomain: "wrestleswap.firebaseapp.com",
            projectId: "wrestleswap",
            storageBucket: "wrestleswap.firebasestorage.app",
            messagingSenderId: "857051782398",
            appId: "1:857051782398:web:bb4ab3f98e8dbbc8cad9af",
            measurementId: "G-B411WXLF3J"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Make Firebase available globally
        window.firebaseDb = db;
        window.getDoc = getDoc;
        window.doc = doc;
    </script>

    <script>
        // Get order/product ID from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('productId');
        const orderId = urlParams.get('orderId');

        async function loadOrderDetails() {
            // First try to get order info from session storage (if just created)
            const orderInfoStr = sessionStorage.getItem('orderInfo');
            const checkoutProductStr = sessionStorage.getItem('checkoutProduct');

            let orderInfo = null;
            let product = null;

            if (orderInfoStr) {
                try {
                    orderInfo = JSON.parse(orderInfoStr);
                    console.log('Order info from session:', orderInfo);
                } catch (e) {
                    console.error('Error parsing order info:', e);
                }
            }

            if (checkoutProductStr) {
                try {
                    product = JSON.parse(checkoutProductStr);
                    console.log('Product from session:', product);
                } catch (e) {
                    console.error('Error parsing product:', e);
                }
            }

            // If we have product ID, try to load from Firebase
            if (productId && window.firebaseDb) {
                try {
                    const productRef = window.doc(window.firebaseDb, 'products', productId);
                    const productSnap = await window.getDoc(productRef);
                    
                    if (productSnap.exists()) {
                        const firebaseProduct = productSnap.data();
                        console.log('Product from Firebase:', firebaseProduct);
                        
                        // Use Firebase data if available
                        if (firebaseProduct.trackingNumber) {
                            orderInfo = orderInfo || {};
                            orderInfo.trackingNumber = firebaseProduct.trackingNumber;
                            orderInfo.trackingUrl = firebaseProduct.trackingUrl;
                            orderInfo.shippingLabel = firebaseProduct.shippingLabel;
                        }
                        
                        // Update product with Firebase data
                        product = product || {};
                        Object.assign(product, firebaseProduct);
                    }
                } catch (error) {
                    console.error('Error loading from Firebase:', error);
                }
            }

            // Display the information
            displayOrderInfo(orderInfo, product);
        }

        function displayOrderInfo(orderInfo, product) {
            // Display order ID
            const displayOrderId = orderId || (orderInfo?.orderId) || 'N/A';
            document.getElementById('order-id').textContent = displayOrderId;

            // Display order date
            const orderDate = new Date();
            document.getElementById('order-date').textContent = orderDate.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            // Display shipping service
            const shippingService = orderInfo?.shippingService || 'Standard Shipping';
            document.getElementById('shipping-service').textContent = shippingService;

            // Display tracking number
            if (orderInfo?.trackingNumber) {
                document.getElementById('tracking-number').textContent = orderInfo.trackingNumber;
                document.getElementById('tracking-number-display').textContent = orderInfo.trackingNumber;
            } else {
                document.getElementById('tracking-number').textContent = 'Not available';
                document.getElementById('tracking-number-display').textContent = 'Not available';
            }

            // Set up shipping label download button
            if (orderInfo?.labelUrl) {
                const downloadBtn = document.getElementById('download-label-btn');
                downloadBtn.href = orderInfo.labelUrl;
                downloadBtn.style.display = 'inline-block';
            } else {
                document.getElementById('download-label-btn').textContent = '‚ö†Ô∏è Label Not Available';
                document.getElementById('download-label-btn').style.background = '#dc3545';
                document.getElementById('download-label-btn').style.cursor = 'not-allowed';
                document.getElementById('download-label-btn').onclick = function(e) {
                    e.preventDefault();
                    alert('Shipping label is not available. Please contact support.');
                };
            }

            // Set up tracking button
            if (orderInfo?.trackingUrl) {
                const trackBtn = document.getElementById('track-shipment-btn');
                trackBtn.href = orderInfo.trackingUrl;
            } else {
                document.getElementById('track-shipment-btn').style.display = 'none';
            }

            // Display product
            if (product) {
                displayProduct(product);
                
                // Update package dimensions if available from Firebase
                if (product.packageDimensions) {
                    const dims = product.packageDimensions;
                    const packageInfoDiv = document.querySelector('.package-info');
                    if (packageInfoDiv) {
                        packageInfoDiv.innerHTML = `
                            <div class="package-row">
                                <span>Package Size:</span>
                                <span>${dims.length}" x ${dims.width}" x ${dims.height}"</span>
                            </div>
                            <div class="package-row">
                                <span>Weight:</span>
                                <span>${dims.weight} ${dims.weightUnit || 'lbs'}</span>
                            </div>
                        `;
                    }
                }
            }

            // Display shipping address (this would come from the order)
            // For now, showing placeholder
            document.getElementById('shipping-address').innerHTML = `
                <div class="address-title">Buyer's Shipping Address:</div>
                <div class="address-line">
                    <strong>Note:</strong> The complete shipping address is printed on the shipping label.<br>
                    Please use the downloaded label for accurate address information.
                </div>
            `;
        }

        function displayProduct(product) {
            const orderItemsDiv = document.getElementById('order-items');
            
            // Determine if image is URL or emoji
            const isImageUrl = product.image && (
                product.image.startsWith('http://') || 
                product.image.startsWith('https://') || 
                product.image.startsWith('data:image')
            );

            const imageHtml = isImageUrl 
                ? `<img src="${product.image}" alt="${product.name}">`
                : product.image || 'üì¶';

            orderItemsDiv.innerHTML = `
                <div class="order-item">
                    <div class="item-image">${imageHtml}</div>
                    <div class="item-details">
                        <div class="item-name">${product.name || 'Product'}</div>
                        ${product.condition ? `<div class="item-condition">Condition: ${product.condition}</div>` : ''}
                        <div class="item-price">Sold for: $${(product.price || 0).toFixed(2)}</div>
                    </div>
                </div>
            `;
        }

        // Load order details when page loads
        window.addEventListener('DOMContentLoaded', loadOrderDetails);
    </script>
</body>
</html>