<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASICS Matflex 6 Wrestling Shoes | Wrestle Swap</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background-color: #f7f7f7; }
        .top-bar { background-color: #f7f7f7; border-bottom: 1px solid #e5e5e5; padding: 8px 0; font-size: 12px; }
        .top-bar-content { max-width: 1280px; margin: 0 auto; padding: 0 20px; display: flex; justify-content: space-between; }
        .top-bar a { color: #000; text-decoration: none; margin: 0 10px; }
        .main-header { background-color: #fff; padding: 12px 0; border-bottom: 1px solid #e5e5e5; }
        .header-content { max-width: 1280px; margin: 0 auto; padding: 0 20px; display: flex; align-items: center; gap: 20px; }
        .logo { font-size: 28px; font-weight: bold; color: #c41e3a; text-decoration: none; }
        .breadcrumb { background-color: #fff; padding: 12px 0; border-bottom: 1px solid #e5e5e5; font-size: 13px; }
        .breadcrumb-content { max-width: 1280px; margin: 0 auto; padding: 0 20px; }
        .breadcrumb a { color: #3665f3; text-decoration: none; }
        .container { max-width: 1280px; margin: 30px auto; padding: 0 20px; }
        .product-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; background: #fff; padding: 30px; border-radius: 8px; }
        .image-gallery { display: flex; flex-direction: column; gap: 15px; }
        .main-image-container { width: 100%; height: 500px; background: #f0f0f0; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid #e5e5e5; }
        .main-image { font-size: 200px; cursor: zoom-in; }
        .thumbnail-container { display: flex; gap: 10px; overflow-x: auto; }
        .thumbnail { width: 80px; height: 80px; background: #f0f0f0; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; border: 2px solid transparent; flex-shrink: 0; }
        .thumbnail.active { border-color: #3665f3; }
        .thumbnail:hover { border-color: #3665f3; }
        .product-info { display: flex; flex-direction: column; }
        .product-title { font-size: 28px; margin-bottom: 10px; color: #333; }
        .product-condition { font-size: 14px; color: #707070; margin-bottom: 5px; }
        .product-rating { display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .stars { color: #ffa500; font-size: 16px; }
        .rating-count { color: #3665f3; font-size: 14px; text-decoration: none; }
        .rating-count:hover { text-decoration: underline; }
        .divider { border-top: 1px solid #e5e5e5; margin: 20px 0; }
        .price-section { margin-bottom: 25px; }
        .price { font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .shipping { font-size: 14px; color: #28a745; font-weight: 500; }
        .option-section { margin-bottom: 25px; }
        .option-label { font-size: 14px; font-weight: bold; margin-bottom: 10px; color: #333; }
        .action-buttons { display: flex; flex-direction: column; gap: 15px; margin-bottom: 25px; }
        .btn { padding: 16px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; transition: all 0.2s; }
        .btn-primary { background-color: #3665f3; color: white; }
        .btn-primary:hover { background-color: #2348c5; }
        .btn-secondary { background-color: #fff; color: #333; border: 2px solid #333; }
        .btn-secondary:hover { background-color: #f0f0f0; }
        .wishlist-btn { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .wishlist-btn.in-watchlist { background-color: #e3f2fd; border-color: #3665f3; color: #3665f3; }
        .details-section { margin-top: 25px; }
        .details-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; }
        .details-grid { display: grid; grid-template-columns: 150px 1fr; gap: 12px; font-size: 14px; }
        .detail-label { color: #707070; }
        .detail-value { color: #333; font-weight: 500; }
        .description { line-height: 1.6; color: #333; margin-top: 15px; }
        .seller-section { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-top: 25px; }
        .seller-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .seller-name { font-size: 16px; font-weight: bold; color: #333; }
        .seller-rating { font-size: 14px; color: #28a745; }
        .seller-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 15px; }
        .stat { text-align: center; }
        .stat-value { font-size: 20px; font-weight: bold; color: #333; }
        .stat-label { font-size: 12px; color: #707070; }
        .contact-seller-btn { width: 100%; padding: 12px; background: #fff; border: 2px solid #3665f3; color: #3665f3; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .contact-seller-btn:hover { background: #e3f2fd; }
        .related-section { margin-top: 60px; }
        .section-title { font-size: 24px; font-weight: bold; margin-bottom: 25px; color: #333; }
        .related-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        .related-item { background: #fff; border: 1px solid #e5e5e5; border-radius: 8px; overflow: hidden; cursor: pointer; transition: box-shadow 0.2s; }
        .related-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .related-image { width: 100%; height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 60px; }
        .related-info { padding: 15px; }
        .related-name { font-size: 14px; color: #333; margin-bottom: 8px; height: 40px; overflow: hidden; }
        .related-price { font-size: 18px; font-weight: bold; color: #333; }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #333; color: white; padding: 16px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 1000; animation: slideIn 0.3s ease-out; display: flex; align-items: center; gap: 12px; max-width: 400px; }
        .toast.success { background: #28a745; }
        .toast.error { background: #dc3545; }
        @keyframes slideIn { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes slideOut { from { transform: translateX(0); opacity: 1; } to { transform: translateX(400px); opacity: 0; } }
        .toast.hiding { animation: slideOut 0.3s ease-out forwards; }
        .cart-badge { display: inline-block; background: #c41e3a; color: white; border-radius: 50%; padding: 2px 6px; font-size: 11px; font-weight: bold; margin-left: 4px; }
        .shipping-rate { display: flex; justify-content: space-between; align-items: center; padding: 12px; margin-bottom: 8px; background: white; border: 2px solid #e5e5e5; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .shipping-rate:hover { border-color: #3665f3; background: #f8f9ff; }
        .shipping-rate.selected { border-color: #3665f3; background: #e3f2fd; }
        .shipping-rate-info { flex: 1; }
        .shipping-rate-name { font-weight: bold; font-size: 14px; color: #333; margin-bottom: 3px; }
        .shipping-rate-details { font-size: 12px; color: #707070; }
        .shipping-rate-price { font-size: 18px; font-weight: bold; color: #3665f3; }
        .shipping-loading { text-align: center; padding: 20px; color: #707070; }
        .shipping-error { padding: 12px; background: #fee; border: 1px solid #fcc; border-radius: 4px; color: #c00; font-size: 13px; }
        @media (max-width: 968px) { .product-layout { grid-template-columns: 1fr; } .main-image-container { height: 400px; } .toast { bottom: 20px; right: 20px; left: 20px; max-width: none; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-content">
            <div>
                <a href="signin.html">Hi! Sign in or register</a>
                <a href="help.html">Help & Contact</a>
            </div>
            <div>
                <a href="sell.html">Sell</a>
                <a href="watchlist.html">Watchlist <span id="watchlist-count" class="cart-badge" style="display: none;">0</span></a>
                <a href="cart.html">üõí Cart <span id="cart-count" class="cart-badge" style="display: none;">0</span></a>
            </div>
        </div>
    </div>
    <div class="main-header">
        <div class="header-content">
            <a href="index.html" class="logo">Wrestle Swap</a>
        </div>
    </div>
    <div class="breadcrumb">
        <div class="breadcrumb-content">
            <a href="index.html">Home</a> > 
            <a href="search.html?q=shoe">Wrestling Shoes</a> > 
            <strong>ASICS Matflex 6</strong>
        </div>
    </div>
    <div class="container">
        <div class="product-layout">
            <div class="image-gallery">
                <div class="main-image-container">
                    <div class="main-image" id="main-image">üëü</div>
                </div>
                <div class="thumbnail-container">
                    <div class="thumbnail active" onclick="changeImage(0)">üëü</div>
                    <div class="thumbnail" onclick="changeImage(1)">üëü</div>
                    <div class="thumbnail" onclick="changeImage(2)">üëü</div>
                    <div class="thumbnail" onclick="changeImage(3)">üëü</div>
                </div>
            </div>
            <div class="product-info">
                <h1 class="product-title">ASICS Matflex 6 Wrestling Shoes - Black/Silver</h1>
                <div class="product-condition">Condition: Used - Excellent</div>
                <div class="product-rating">
                    <span class="stars">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</span>
                    <a href="#" class="rating-count">(24 reviews)</a>
                </div>
                <div class="divider"></div>
                <div class="price-section">
                    <div class="price">$49.99</div>
                    <div class="shipping">‚úì Free Shipping</div>
                </div>
                <div class="option-section">
                    <div class="option-label">üìç Item Location:</div>
                    <div style="font-size: 15px; color: #333; margin-top: 5px;"><strong>Vestal, NY 13850</strong></div>
                    <div style="font-size: 13px; color: #707070; margin-top: 5px;">Ships from New York</div>
                </div>
                <div class="option-section" style="background: #f9f9f9; padding: 20px; border-radius: 8px;">
                    <div class="option-label">üì¶ Calculate Shipping Cost</div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="shipping-zip" placeholder="Enter your ZIP code" style="width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px;" maxlength="5" />
                    </div>
                    <button onclick="calculateShipping()" style="width: 100%; padding: 12px; background: #3665f3; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">Get Shipping Rates</button>
                    <div id="shipping-results" style="margin-top: 15px;"></div>
                </div>
                <div class="action-buttons">
                    <button class="btn btn-secondary" onclick="buyNow()">Buy This item</button>
                    <button class="btn btn-secondary wishlist-btn" id="watchlist-btn" onclick="toggleWatchlist()">
                        <span id="heart-icon">‚ô°</span> <span id="watchlist-text">Add to Watchlist</span>
                    </button>
                </div>
                <div class="details-section">
                    <div class="details-title">Product Details</div>
                    <div class="details-grid">
                        <div class="detail-label">Brand:</div><div class="detail-value">ASICS</div>
                        <div class="detail-label">Model:</div><div class="detail-value">Matflex 6</div>
                        <div class="detail-label">Color:</div><div class="detail-value">Black/Silver</div>
                        <div class="detail-label">Size:</div><div class="detail-value">10 (US Men's)</div>
                        <div class="detail-label">Condition:</div><div class="detail-value">Used - Excellent</div>
                        <div class="detail-label">Material:</div><div class="detail-value">Synthetic Leather</div>
                    </div>
                    <div class="description">
                        <strong>Description:</strong><br><br>
                        These ASICS Matflex 6 wrestling shoes are in excellent used condition with minimal wear. Perfect for wrestlers of all levels. Features include breathable mesh panels, excellent grip, and lightweight construction. Only worn for one season. No major scuffs or damage. Comes from a smoke-free home.
                        <br><br>
                        Great for practice and competition. Don't miss this deal on quality wrestling shoes!
                    </div>
                </div>
                <div class="seller-section">
                    <div class="seller-header">
                        <div class="seller-name">Sold by: wrestlingpro23</div>
                        <div class="seller-rating">‚≠ê 98.5% positive</div>
                    </div>
                    <div class="seller-stats">
                        <div class="stat"><div class="stat-value">156</div><div class="stat-label">Items Sold</div></div>
                        <div class="stat"><div class="stat-value">4.9</div><div class="stat-label">Rating</div></div>
                        <div class="stat"><div class="stat-value">2 days</div><div class="stat-label">Avg Ship Time</div></div>
                    </div>
                    <button class="contact-seller-btn" onclick="contactSeller()">Contact Seller</button>
                </div>
            </div>
        </div>
        <div class="related-section">
            <h2 class="section-title">Similar Items You May Like</h2>
            <div class="related-grid">
                <div class="related-item" onclick="window.location.reload()">
                    <div class="related-image">üëü</div>
                    <div class="related-info">
                        <div class="related-name">Adidas HVC 2 Wrestling Shoes - Size 10</div>
                        <div class="related-price">$45.00</div>
                    </div>
                </div>
                <div class="related-item" onclick="window.location.reload()">
                    <div class="related-image">üëü</div>
                    <div class="related-info">
                        <div class="related-name">Nike Inflict 3 Wrestling Shoes - Black</div>
                        <div class="related-price">$89.99</div>
                    </div>
                </div>
                <div class="related-item" onclick="window.location.reload()">
                    <div class="related-image">üëü</div>
                    <div class="related-info">
                        <div class="related-name">ASICS Aggressor 4 - Blue/White</div>
                        <div class="related-price">$72.50</div>
                    </div>
                </div>
                <div class="related-item" onclick="window.location.reload()">
                    <div class="related-image">üëü</div>
                    <div class="related-info">
                        <div class="related-name">Rudis KS Elite Wrestling Shoes</div>
                        <div class="related-price">$95.00</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyBrNzOA__bI6zA2PvTFTujmFiBLsCe1iBk",
            authDomain: "wrestleswap.firebaseapp.com",
            projectId: "wrestleswap",
            storageBucket: "wrestleswap.firebasestorage.app",
            messagingSenderId: "857051782398",
            appId: "1:857051782398:web:bb4ab3f98e8dbbc8cad9af",
            measurementId: "G-B411WXLF3J"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let currentUser = null;
        onAuthStateChanged(auth, (user) => { if (user) { currentUser = user; } });
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.getCurrentUser = () => currentUser;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
    <script>
        const product = { id: 'asics-matflex-6', name: 'ASICS Matflex 6 Wrestling Shoes - Black/Silver', price: 49.99, image: 'üëü', condition: 'Used - Excellent', seller: 'wrestlingpro23', sellerId: 'user123' };
        window.addEventListener('DOMContentLoaded', function() { updateCartCount(); updateWatchlistCount(); checkWatchlistStatus(); });
        function changeImage(index) { document.querySelectorAll('.thumbnail').forEach(thumb => { thumb.classList.remove('active'); }); document.querySelectorAll('.thumbnail')[index].classList.add('active'); }
        function getCart() { const cart = localStorage.getItem('wrestleSwapCart'); return cart ? JSON.parse(cart) : []; }
        function saveCart(cart) { localStorage.setItem('wrestleSwapCart', JSON.stringify(cart)); updateCartCount(); }
        function getWatchlist() { const watchlist = localStorage.getItem('wrestleSwapWatchlist'); return watchlist ? JSON.parse(watchlist) : []; }
        function saveWatchlist(watchlist) { localStorage.setItem('wrestleSwapWatchlist', JSON.stringify(watchlist)); updateWatchlistCount(); }
        function updateCartCount() { const cart = getCart(); const badge = document.getElementById('cart-count'); if (cart.length > 0) { badge.textContent = cart.length; badge.style.display = 'inline-block'; } else { badge.style.display = 'none'; } }
        function updateWatchlistCount() { const watchlist = getWatchlist(); const badge = document.getElementById('watchlist-count'); if (watchlist.length > 0) { badge.textContent = watchlist.length; badge.style.display = 'inline-block'; } else { badge.style.display = 'none'; } }
        function checkWatchlistStatus() { const watchlist = getWatchlist(); const isInWatchlist = watchlist.some(item => item.id === product.id); if (isInWatchlist) { document.getElementById('watchlist-btn').classList.add('in-watchlist'); document.getElementById('heart-icon').textContent = '‚ô•'; document.getElementById('watchlist-text').textContent = 'In Watchlist'; } }
        function showToast(message, type = 'success') { const existingToast = document.querySelector('.toast'); if (existingToast) { existingToast.remove(); } const toast = document.createElement('div'); toast.className = `toast ${type}`; toast.innerHTML = `<span style="font-size: 20px;">${type === 'success' ? '‚úì' : '‚úï'}</span><span>${message}</span>`; document.body.appendChild(toast); setTimeout(() => { toast.classList.add('hiding'); setTimeout(() => toast.remove(), 300); }, 3000); }
        function addToCart() { const cart = getCart(); const existingItem = cart.find(item => item.id === product.id); if (existingItem) { existingItem.quantity += 1; showToast('Quantity updated in cart!'); } else { cart.push({ ...product, quantity: 1, addedAt: new Date().toISOString() }); showToast('Added to cart successfully!'); } saveCart(cart); }
        function buyNow() { const cart = getCart(); const existingItem = cart.find(item => item.id === product.id); if (!existingItem) { cart.push({ ...product, quantity: 1, addedAt: new Date().toISOString() }); saveCart(cart); } showToast('Proceeding to checkout...', 'success'); setTimeout(() => { showToast('Checkout page would open here', 'success'); }, 1000); }
        function toggleWatchlist() { const watchlist = getWatchlist(); const existingIndex = watchlist.findIndex(item => item.id === product.id); if (existingIndex > -1) { watchlist.splice(existingIndex, 1); document.getElementById('watchlist-btn').classList.remove('in-watchlist'); document.getElementById('heart-icon').textContent = '‚ô°'; document.getElementById('watchlist-text').textContent = 'Add to Watchlist'; showToast('Removed from watchlist'); } else { watchlist.push({ ...product, addedAt: new Date().toISOString() }); document.getElementById('watchlist-btn').classList.add('in-watchlist'); document.getElementById('heart-icon').textContent = '‚ô•'; document.getElementById('watchlist-text').textContent = 'In Watchlist'; showToast('Added to watchlist!'); } saveWatchlist(watchlist); }

        // FIXED SHIPPING CALCULATOR - Uses ShipEngine (No Cloud Function!)
        // UPDATED calculateShipping() for your product-page.html
// Replace your current calculateShipping() function with this:

        async function calculateShipping() {
            const zipInput = document.getElementById('shipping-zip');
            const resultsDiv = document.getElementById('shipping-results');
            const zipCode = zipInput.value.trim();
            
            if (!zipCode || zipCode.length !== 5 || !/^\d{5}$/.test(zipCode)) {
                resultsDiv.innerHTML = '<div class="shipping-error">Please enter a valid 5-digit ZIP code</div>';
                return;
            }
            
            resultsDiv.innerHTML = '<div class="shipping-loading">‚è≥ Calculating shipping rates...</div>';
            
            try {
                // Call YOUR Netlify function (not ShipEngine directly!)
                const response = await fetch('/.netlify/functions/get-shipping-rates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ zipCode: zipCode })
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to get rates');
                }
                
                const rates = await response.json();
                console.log('Received rates:', rates);
                
                if (rates && rates.length > 0) {
                    displayShippingRatesNetlify(rates);
                } else {
                    resultsDiv.innerHTML = '<div class="shipping-error">No shipping rates available for this location</div>';
                }
                
            } catch (error) {
                console.error('Shipping error:', error);
                resultsDiv.innerHTML = `<div class="shipping-error">Unable to calculate shipping: ${error.message}</div>`;
            }
        }

        // New display function for Netlify response format
        function displayShippingRatesNetlify(rates) {
            const resultsDiv = document.getElementById('shipping-results');
            
            // Sort by price
            const sortedRates = rates
                .filter(r => r.shipping_amount && r.shipping_amount.amount)
                .sort((a, b) => a.shipping_amount.amount - b.shipping_amount.amount)
                .slice(0, 5);
            
            if (sortedRates.length === 0) {
                resultsDiv.innerHTML = '<div class="shipping-error">No available shipping options</div>';
                return;
            }
            
            let html = '<div style="font-size: 13px; font-weight: bold; margin-bottom: 10px; color: #333;">Available Shipping Options:</div>';
            
            sortedRates.forEach((rate, index) => {
                const price = rate.shipping_amount.amount;
                const days = rate.delivery_days || 'N/A';
                const carrier = rate.carrier_friendly_name || rate.carrier_id || 'Carrier';
                const service = rate.service_type || 'Standard';
                
                html += `
                    <div class="shipping-rate" onclick="selectShippingRate('${rate.rate_id || index}', ${price})">
                        <div class="shipping-rate-info">
                            <div class="shipping-rate-name">${carrier} - ${service}</div>
                            <div class="shipping-rate-details">
                                ${days !== 'N/A' ? `Estimated delivery: ${days} business days` : 'Delivery time varies'}
                            </div>
                        </div>
                        <div class="shipping-rate-price">$${price.toFixed(2)}</div>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }

// Keep your existing selectShippingRate and updatePriceWithShipping functions
        function displayShippingRates(rates) {
            const resultsDiv = document.getElementById('shipping-results');
            const sortedRates = rates.filter(r => r.shipping_amount).sort((a, b) => a.shipping_amount.amount - b.shipping_amount.amount).slice(0, 5);
            if (sortedRates.length === 0) { resultsDiv.innerHTML = '<div class="shipping-error">No options available</div>'; return; }
            let html = '<div style="font-size: 13px; font-weight: bold; margin-bottom: 10px; color: #333;">Available Shipping:</div>';
            sortedRates.forEach(rate => {
                const price = rate.shipping_amount.amount;
                const days = rate.delivery_days || 'N/A';
                const carrier = rate.carrier_friendly_name || rate.carrier_id;
                const service = rate.service_type || 'Standard';
                html += `<div class="shipping-rate" onclick="selectShippingRate('${rate.rate_id}', ${price})"><div class="shipping-rate-info"><div class="shipping-rate-name">${carrier} - ${service}</div><div class="shipping-rate-details">${days !== 'N/A' ? `${days} business days` : 'Delivery varies'}</div></div><div class="shipping-rate-price">$${price.toFixed(2)}</div></div>`;
            });
            resultsDiv.innerHTML = html;
        }
        let selectedShippingRate = null;
        function selectShippingRate(rateId, price) { selectedShippingRate = { id: rateId, price: price }; document.querySelectorAll('.shipping-rate').forEach(el => { el.classList.remove('selected'); }); event.currentTarget.classList.add('selected'); updatePriceWithShipping(price); showToast(`Shipping option selected: $${price.toFixed(2)}`); }
        function updatePriceWithShipping(shippingCost) { const priceElement = document.querySelector('.price'); const originalPrice = product.price; const totalPrice = originalPrice + shippingCost; priceElement.innerHTML = `$${originalPrice.toFixed(2)}<span style="font-size: 14px; color: #707070; font-weight: normal; display: block; margin-top: 5px;">+ $${shippingCost.toFixed(2)} shipping = $${totalPrice.toFixed(2)} total</span>`; }

        async function contactSeller() {
            const user = window.getCurrentUser();
            if (!user) { showToast('Please sign in to message sellers', 'error'); setTimeout(() => { window.location.href = 'sign-in.html?redirect=' + encodeURIComponent(window.location.href); }, 1500); return; }
            try {
                const conversationId = [user.uid, product.sellerId].sort().join('_');
                const db = window.firebaseDb;
                const conversationRef = window.firebaseDoc(db, 'conversations', conversationId);
                await window.firebaseSetDoc(conversationRef, { participants: [user.uid, product.sellerId], participantNames: { [user.uid]: user.displayName || user.email?.split('@')[0] || 'Anonymous', [product.sellerId]: product.seller }, lastMessage: '', lastMessageTime: window.firebaseServerTimestamp(), productId: product.id, productName: product.name }, { merge: true });
                window.location.href = `messages.html?conversation=${conversationId}&seller=${encodeURIComponent(product.seller)}&sellerId=${product.sellerId}`;
            } catch (error) { console.error('Error opening conversation:', error); showToast('Failed to open conversation. Please try again.', 'error'); }
        }
    </script>
</body>
</html>